# 프로시저럴 던전 생성 시스템

## 시스템 개요

프로시저럴 던전 생성 시스템은 포트폴리오의 핵심 기술 요소로, 매 게임마다 고유한 던전 레이아웃을 생성하는 알고리즘을 구현합니다. 이 시스템은 타일 기반 그리드와 BSP(Binary Space Partitioning) 알고리즘을 결합하여 다양하고 탐험 가치가 있는 던전을 생성합니다.

## 구현 목표

1. **변화하는 레이아웃**: 매 세션마다 다른 던전 구조 생성
2. **게임플레이 고려**: 탐험, 전투, 탈출에 적합한 공간 제공
3. **시각적 다양성**: 단일 테마 내에서 시각적 변화 제공
4. **성능 최적화**: 빠른 생성 시간과 효율적인 렌더링
5. **확장성**: 추후 추가 테마와 규칙 적용 가능한 구조

## 핵심 알고리즘

### BSP(Binary Space Partitioning)
- **공간 분할**: 전체 공간을 재귀적으로 분할하여 방 후보 영역 생성
- **파라미터**: 최소/최대 방 크기, 분할 깊이, 분할 비율 범위
- **구현 단계**:
  1. 초기 공간 설정
  2. 재귀적 분할 수행 (가로/세로 랜덤 선택)
  3. 종료 조건 충족 시 리프 노드에 방 생성
  4. BSP 트리 구조 저장

### 방 생성 및 배치
- **방 생성**: 파티션 내에 랜덤 크기의 방 생성
- **특수 방**: 입구, 출구, 보물실 등 특수 목적 방 지정
- **구현 단계**:
  1. 각 리프 노드에서 여백을 고려한 방 크기 결정
  2. 방 위치 및 크기 데이터 저장
  3. 특수 방 지정 (위치 및 접근성 기준)

### 복도 연결
- **연결 알고리즘**: BSP 트리 구조를 활용한 인접 방 연결
- **복도 생성**: L자 또는 직선 복도 생성
- **구현 단계**:
  1. BSP 트리 순회하며 인접 노드 식별
  2. 각 인접 노드 간 최적 경로 계산
  3. 복도 타일 배치 및 경로 연결

### 타일 배치 및 그래픽
- **타일 시스템**: 그리드 기반 타일 맵 구현
- **타일 종류**: 바닥, 벽, 문, 장애물 등
- **구현 단계**:
  1. 전체 그리드 초기화
  2. 방 영역에 바닥 타일 배치
  3. 복도 타일 배치
  4. 벽 및 경계 타일 계산 및 배치
  5. 문 및 특수 타일 배치

### 오브젝트 배치
- **몬스터 배치**: 난이도와 위치를 고려한 몬스터 스폰
- **보물 및 아이템**: 보상 분배 알고리즘
- **함정 및 장애물**: 위험 요소 배치
- **구현 단계**:
  1. 방 용도에 따른 오브젝트 타입 결정
  2. 배치 규칙 및 제약조건 적용
  3. 충돌 및 경로 막힘 방지 검증

## 데이터 구조

### 그리드 시스템
```csharp
// 기본 타일 데이터 구조
public enum TileType { Empty, Floor, Wall, Door, Obstacle }

public class Tile
{
    public TileType Type { get; set; }
    public Vector2Int Position { get; set; }
    public bool IsExplored { get; set; }
    public GameObject TileObject { get; set; }
}

// 전체 던전 그리드
public class DungeonGrid
{
    private Tile[,] tiles;
    private int width, height;
    
    // 그리드 조작 메서드들...
}
```

### 방 및 복도 표현
```csharp
// 방 데이터 구조
public enum RoomType { Normal, Entrance, Exit, Treasure, Boss }

public class Room
{
    public RectInt Bounds { get; set; }
    public RoomType Type { get; set; }
    public List<Room> ConnectedRooms { get; set; }
    public List<Corridor> Corridors { get; set; }
}

// 복도 데이터 구조
public class Corridor
{
    public List<Vector2Int> Path { get; set; }
    public Room RoomA { get; set; }
    public Room RoomB { get; set; }
}
```

### BSP 트리 구조
```csharp
// BSP 트리 노드
public class BSPNode
{
    public RectInt Space { get; set; }
    public BSPNode Left { get; set; }
    public BSPNode Right { get; set; }
    public Room Room { get; set; }
    public bool IsLeaf => Left == null && Right == null;
}
```

## 구현 계획

### 1일차: 기본 구조 및 BSP 알고리즘
- 프로젝트 구조 설정
- 기본 데이터 구조 구현
- BSP 분할 알고리즘 구현
- 간단한 시각화 도구 제작

### 2일차: 방 생성 및 복도 연결
- 방 생성 로직 구현
- 방 타입 지정 알고리즘
- 복도 연결 알고리즘 구현
- BSP 트리 시각화 도구 제작

### 3일차: 타일 배치 및 그래픽
- 타일 시스템 구현
- 벽 및 경계 계산 알고리즘
- 기본 타일 그래픽 적용
- 첫 번째 완전한 던전 생성 테스트

### 4일차: 오브젝트 배치 및 최적화
- 몬스터 스폰 포인트 계산
- 보물 및 아이템 배치 알고리즘
- 함정 및 장애물 배치
- 성능 최적화 및 메모리 사용 개선

### 5일차: 테스트 및 조정
- 다양한 파라미터로 던전 생성 테스트
- 생성된 던전의 게임플레이 테스트
- 알고리즘 파라미터 미세 조정
- 난이도 및 복잡성 밸런싱

## 확장 계획 (시간이 허락하는 경우)

1. **셀룰러 오토마타**: 자연스러운 동굴형 영역 생성
2. **테마 변형**: 단일 테마 내 시각적 변화 구현
3. **멀티 레이어**: 수직 연결이 있는 다층 던전 생성
4. **환경 효과**: 물, 용암, 식물 등 특수 환경 요소 적용
5. **런타임 수정**: 플레이어 행동에 따른 던전 동적 변형

## 시각적 표현

포트폴리오 데모에서는 다음과 같은 시각적 요소를 구현할 계획입니다:

1. **타일 그래픽**: 기본 던전 테마에 맞는 타일셋
2. **조명 시스템**: 동적 조명 및 그림자
3. **파티클 효과**: 환경 분위기를 조성하는 파티클
4. **프로시저럴 장식**: 랜덤하게 배치되는 장식 요소
5. **미니맵**: 탐험한 영역을 표시하는 미니맵 시스템

## 기술적 도전과 해결책

### 도전 1: 연결성 보장
- **문제**: 모든 방이 접근 가능하도록 보장
- **해결책**: 최소 스패닝 트리 알고리즘으로 필수 연결 보장 후 추가 연결 랜덤 추가

### 도전 2: 성능 최적화
- **문제**: 대규모 던전의 생성 및 렌더링 성능
- **해결책**: 청크 기반 생성 및 로딩, 오클루전 컬링, LOD 시스템

### 도전 3: 시각적 일관성
- **문제**: 랜덤 생성이지만 시각적으로 일관된 환경 제공
- **해결책**: 규칙 기반 타일 선택 및 자동 타일링 시스템 구현

## 평가 기준

포트폴리오 프로젝트로서 이 시스템의 성공 여부는 다음 기준으로 평가합니다:

1. **다양성**: 충분히 다양한 레이아웃 생성 능력
2. **성능**: 실시간 게임에서 허용 가능한 생성 시간
3. **게임플레이**: 재미있고 탐험 가치가 있는 공간 창출
4. **안정성**: 버그나 오류 없이 일관된 결과 제공
5. **코드 품질**: 확장 가능하고 이해하기 쉬운 구현

[메인 계획으로 돌아가기](./MasterPlan.md)
